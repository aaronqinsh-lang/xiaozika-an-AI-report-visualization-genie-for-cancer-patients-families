## 小紫卡 - 病情管理与可视化助手产品需求文档 (PRD)

### 1. 产品概述

#### 1.1 产品定义  
小紫卡是一款面向肿瘤患者及其家属的**病情数据管理与可视化助手**。  
通过拍照/上传检查报告/模版导入等方式，将复杂的化验单和检查结果自动解析并结构化存入 Supabase，支持时间维度的动态趋势图、多指标联动分析，以及结合治疗方案过程的病情可视化。同时，内嵌语音+文本 AI 助手，帮助用户用自然语言理解病情变化、识别风险，并获得照护建议。

#### 1.2 产品愿景  
- 让患者和家属不再被碎片化的报告、指标数字“淹没”，而是用**一张时间线+几张图**就理解病情走向。  
- 让指标管理、趋势判断、方案对比变成**“一键方案”+可视化**，而不是反复翻找化验单。  
- 让 AI 成为贴身的“病情数据解读助手”，在尊重医生诊疗前提下，**帮助患者提问更好问题、做好就诊准备**。

---

### 2. 目标用户

#### 2.1 主要用户群体
- 正在接受肿瘤治疗的患者（化疗 / 放疗 / 靶向 / 免疫等）
- 肿瘤患者家属与照护者
- 需要长期随访、频繁复查指标的患者（尤其晚期/复发患者）

#### 2.2 用户画像（示例）

**治疗期患者（40–75 岁）：**
- 每 1–4 周做一次血液/影像检查
- 指标多、报告多，家属常用手机拍照存报告，但难以整体看趋势  
- 担心感染、肝肾负担、血栓风险，但不知道如何从指标判断

**主要照护家属：**
- 承担预约、取报告、记录病情的工作  
- 需要快速回答类似 “最近指标好了吗？”、“这次化疗前指标够不够？” 的问题  
- 希望有一键看图的方式辅助和医生沟通

#### 2.3 用户痛点

- **信息碎片化**：报告散落在手机相册、纸质病历夹、各个医院系统中。
- **理解门槛高**：指标太多，看不懂缩写、参考值，也不知道趋势是否危险。
- **无法按治疗过程看整体**：手术前后、不同化疗方案期间，缺少统一时间线视图。
- **缺少“场景化一键监测”**：不能一键查看“感染风险”、“血栓风险”、“化疗能不能继续”等。
- **沟通困难**：就诊时难以快速向医生展示关键指标变化和问题。

---

### 3. 用户故事 (User Stories)

#### 3.1 报告录入与解析

- **作为** 正在化疗的患者，**我希望** 可以直接拍照上传化验单，系统自动识别指标并保存，**以便** 不需要人工抄写每个数值。
- **作为** 家属，**我希望** 可以批量导入历史报告（用模版或文件上传），**以便** 迅速把过去几个月的病情补齐进系统。
- **作为** 患者，**我希望** 系统在解析后允许我逐项确认和修改，**以便** 避免 AI 识别错误导致的数据问题。

#### 3.2 指标趋势与一键监测

- **作为** 患者，**我希望** 能看到 CA19-9、CEA 等肿瘤标志物的时间趋势图，**以便** 感受治疗是否有效。
- **作为** 患者，**我希望** 有“化疗安全监测”一键方案，自动展示白细胞、中性粒细胞、血小板及 CTCAE5.0 风险提示，**以便** 提前知道是否可能推迟化疗。
- **作为** 患者，**我希望** 有“感染指标预警”、“肝功能监测”、“血栓风险预警”等预设方案，**以便** 一键切图，不用自己选指标。

#### 3.3 可视化与治疗进程联动

- **作为** 患者，**我希望** 在时间轴上同时看到“治疗方案阶段”和“指标变化曲线”，**以便** 理解某个方案是否有效、某次指标恶化是否与治疗相关。
- **作为** 家属，**我希望** 可以横屏查看多指标联动图，**以便** 在病房/门诊与医生一起看图讨论。

#### 3.4 AI 助手与语音交互

- **作为** 患者，**我希望** 能问 AI 助手 “最近感染是不是在好转？”、“这次化疗前血值够不够？”，**以便** 在看医生前心里有数。
- **作为** 高龄患者，**我希望** 可以用语音直接问问题，并用简单语言听解释，**以便** 不用打字、减少理解负担。

#### 3.5 适老模式与可访问性

- **作为** 高龄患者，**我希望** APP 有一键“适老模式”，字体变大、按钮变圆、操作更简单，**以便** 自己能独立查看指标和图表。

---

### 4. 核心功能

#### 4.1 报告采集与解析

- **输入方式**：
  - 拍照上传（相册/相机）
  - 上传 PDF/图片 化验单
  - 模版文件导入（如 CSV/结构化 JSON）
- **自动解析流程**：
  1. 前端将文件上传到 Supabase Storage（带 user_id、日期、报告类型等元信息）。
  2. 调用 Gemini（图像+文本）进行 OCR + 表格结构识别：
     - 提取：报告日期、医院、科室、检查类型。
     - 逐行识别：指标名称/缩写、数值、单位、参考范围、异常标记。
  3. 解析结果以“草稿态”展示给用户，可逐项确认/修正。
  4. 用户确认后将数据写入 Supabase：
     - `lab_reports`：报告头信息。
     - `lab_metrics`：每一项指标数据。

- **支持的报告类型**（可在 UI 用标签或下拉选择）：
  - 肿瘤标志物报告
  - 血常规
  - 肝功能
  - 凝血功能
  - 感染指标
  - 肾功能检查报告
  - 便隐血检查报告

#### 4.2 指标管理与一键监测方案

- **预设一键方案**（可在产品内配置）：
  - **肿瘤标志物趋势**：CA19-9、CEA、CA125、AFP 等。
  - **化疗安全监测**：WBC、NEU、PLT 等 + CTCAE 5.0 分级建议。
  - **胆汁淤积预警**：ALP + GGT。
  - **感染指标预警**：CRP、PCT +/- WBC。
  - **血栓风险预警**：D-二聚体 + 凝血指标。
- **自定义方案**：
  - 用户选择一组指标 + 时间窗口 + 告警规则 → 保存为“监测模版”。
  - 支持一键切换视图，并可横屏展示，适合病房/门诊场景。

#### 4.3 可视化模块

- **单指标动态折线图**：
  - x 轴：时间（按天/周/月聚合）。
  - y 轴：指标数值。
  - 支持正常值区间背景 shading、hover 时显示原始报告和 AI 解释摘要。
- **多指标一致性折线图**：
  - 多条曲线同坐标系（颜色区分）。
  - 支持勾选/取消勾选某个指标。
- **治疗进程联动**：
  - 在同一时间轴上展示治疗阶段条（手术/不同化疗方案/放疗周期）。
  - 指标图与治疗阶段可联动高亮，帮助用户理解“治疗→指标反应”。

#### 4.4 内嵌 AI 助手

- **入口形式**：
  - 全局悬浮**圆形按钮**，紫色色系，带边缘发光与呼吸灯效果。
  - 在非 AI 页面仍可随时唤出对话（浮层形式）。
- **能力范围**：
  - 指标趋势解读：描述最近趋势、相对稳定/好转/恶化。
  - 场景化问答：如“感染风险现在大吗？”、“这次能安全做化疗吗？”（仅提示风险与建议提问，避免诊断）。
  - 治疗进程回顾：结合治疗阶段生成“病程小结”。
- **交互形式**：
  - 文本对话（类似聊天）。
  - 语音对话（通过 Gemini Live API，支持 3 种音色）。

#### 4.5 档案管理模块

- **病情档案**：
  - 肿瘤类型、分期、主要治疗方案、重要时间点（诊断、手术、复发等）。
- **医生管理**：
  - 主诊医生与团队的姓名、医院科室、联系方式。
- **急救管理**：
  - 紧急联系人，重要医疗文档/卡片（如抗凝/支架信息）提示。

#### 4.6 工具模块

- **内容形式**：
  - 病情管理相关小工具与外部链接集合，如：
    - 指南文档（NCCN/CSCO 患者版清单）
    - 国内权威平台的病情管理小程序链接
    - 用药提醒、症状记录等配套工具入口
- **可扩展性**：
  - 后续可通过配置添加更多工具卡片。

#### 4.7 我的 & 设置模块

- **隐私条款与告知书**
- **模型配置**：是否开启 AI 建议、是否允许对话用于模型优化（默认关闭）。
- **数据导出/导入**：支持导出 JSON/CSV，及从模版导入历史数据。

#### 4.8 适老关怀模式

- 全局字体放大（正文 18–20px，标题适当再大一级）。
- UI 组件更圆润、可点击区域更大。
- 精简交互路径，减少复杂手势与层级。
- AI 文案更口语化、短句、少专业术语。

---

### 5. UI / 字体和交互规范

#### 5.1 设计原则

- **去医疗化但保持专业**：界面温暖、结构清晰，但不使用过度“医院化”视觉。
- **信息层级清晰**：重点指标和趋势图一目了然，其他信息按需展开。
- **适配移动端**：优先考虑单手操作、竖屏浏览与横屏图表切换。

#### 5.2 色彩规范

- **主色调**：紫色系（如 `#7C3AED`）——与“小紫卡”品牌呼应，体现专业与安定感。
- **辅助色**（最多 3 种）：
  - 安全/稳定：柔和绿（如 `#10B981`）。
  - 警示/注意：橙色（如 `#F59E0B`）。
  - 严重/危险：红色（如 `#EF4444`）。
- **背景**：浅灰白为主，保证图表和文字对比度良好。

#### 5.3 字体规范

- **中文主字体**：苹方体（PingFang SC）为优先选择。
- **字号**：
  - 标题：20–24px
  - 正文：14–16px
  - 辅助说明：12–14px
- **适老模式**：在上述基础上整体提升 2–4px，保证阅读舒适。

#### 5.4 交互设计要点

- 指标卡片可点击进入详细趋势图。
- 图表支持 pinch 缩放、左右滑动浏览时间线。
- 一键监测方案使用 Tab/Segment 形式快速切换。
- 悬浮 AI 按钮在对话进行中显示“正在聆听/回应”状态（呼吸灯节奏变化）。

---

### 6. 技术要求与系统架构

#### 6.1 总体技术架构（Gemini Build App 版）

```text
┌──────────────────────────────────────┐
│              React 前端              │
│   - 病情可视化 / 指标管理 / 档案     │
└──────────────┬─────────────┬────────┘
               │             │
        ┌──────▼──────┐ ┌───▼────────────────┐
        │  Supabase   │ │  Google Gemini APIs │
        │  (Auth+DB)  │ │  - Gemini 3 Flash   │
        └─────────────┘ │  - Gemini Live     │
                         └────────────────────┘
```

- **前端**：
  - **React 19**
  - **Tailwind CSS**（紫色系主题 + 容易配置适老模式）
  - **Lucide React** 作为图标系统
  - 图表库可选 Recharts / Victory 等（后续确定）

- **AI 层**：
  - **Gemini 3 Flash**：报告解析 & 文本对话。
  - **Gemini Live API**：语音交互（3 种音色）。

- **后端与存储**（Supabase）：
  - Auth：Email 登录 + 未来可扩展 OAuth。
  - Postgres：病情数据存储。
  - Storage：报告原件存储。
  - Edge Functions（可选）：复杂处理或定时任务。

---

### 7. Supabase 数据模型（草案）

```sql
-- 用户档案
profiles (
  id uuid primary key,
  user_id uuid references auth.users(id),
  name text,
  gender text,
  dob date,
  cancer_type text,
  stage text,
  treatment_summary text,
  is_elder_mode boolean default false,
  created_at timestamptz default now()
);

-- 治疗阶段
treatment_courses (
  id uuid primary key,
  user_id uuid references auth.users(id),
  name text,
  type text, -- surgery / chemo / radio / targeted / immuno
  start_date date,
  end_date date,
  notes text
);

-- 报告头信息
lab_reports (
  id uuid primary key,
  user_id uuid references auth.users(id),
  report_date date,
  hospital text,
  department text,
  category text, -- tumor_marker / cbc / liver / coag / infection / kidney / stool
  raw_file_url text,
  ai_parsed_summary text,
  created_at timestamptz default now()
);

-- 报告明细指标
lab_metrics (
  id uuid primary key,
  report_id uuid references lab_reports(id),
  name text,   -- 如 CA19-9
  code text,   -- 统一编码，如 CA199
  value numeric,
  unit text,
  ref_low numeric,
  ref_high numeric,
  is_abnormal boolean,
  created_at timestamptz default now()
);

-- 一键监测方案
monitor_presets (
  id uuid primary key,
  user_id uuid references auth.users(id),
  name text,
  metric_codes jsonb,     -- ["CA199","CEA",...]
  time_window_days int,
  threshold_rules jsonb,  -- 阈值与规则描述
  created_at timestamptz default now()
);

-- AI 对话与会话
ai_sessions (
  id uuid primary key,
  user_id uuid references auth.users(id),
  mode text,  -- text / voice
  started_at timestamptz default now(),
  ended_at timestamptz
);

ai_messages (
  id uuid primary key,
  session_id uuid references ai_sessions(id),
  role text, -- user / assistant / system
  content text,
  created_at timestamptz default now()
);
```

---

### 8. AI 使用策略（Gemini）

- **报告解析 Prompt 思路**：
  - 输入：报告图片 / OCR 文本。
  - 输出：结构化 JSON（指标列表 + 报告元信息）。
  - 强调：不做诊断，仅提取客观数值与标记。

- **病情解读 Prompt 思路**：
  - 输入：
    - 最近 n 次某类指标值；
    - 治疗阶段摘要；
    - 用户问题。
  - 输出：
    - 趋势描述（上升/下降/波动）。
    - 风险提示等级（低/中/高，仅作参考）。
    - 建议问医生的几个关键问题。

- **语音模式**：
  - 使用 Gemini Live 实时通话，前端显示转写文本与简短要点总结。
  - 高龄用户模式下，控制回复长度和术语密度。

---

### 9. 实施路线图（建议）

- **M1：基础架构 & Auth**
  - 初始化 React + Tailwind 项目。
  - 接入 Supabase Auth & profiles。
- **M2：报告上传与解析 MVP**
  - 支持拍照/文件上传。
  - 打通 Gemini 报告解析 → Supabase 写入链路。
  - 先支持 2 类报告（如血常规 + 肿瘤标志物）。
- **M3：可视化与一键监测**
  - 单指标折线图、多指标联动视图。
  - 内置 2–3 个预设监测方案。
- **M4：AI 助手与语音**
  - 全局悬浮 AI 按钮 + 文本聊天。
  - 集成 Gemini Live 实现语音对话。
- **M5：适老模式 & 工具/档案完善**
  - 适老 UI 方案。
  - 档案管理、工具入口、数据导出。

---

### 10. 技术栈总结

| 层级 | 技术选择 | 主要职责 |
|------|----------|----------|
| 前端层 | React 19 + Tailwind CSS + Lucide React | 页面与组件、移动端优先布局、紫色系主题与适老模式、ECharts/图表封装 |
| 数据层 | Supabase (Auth + Postgres + Storage) | 用户认证、档案与指标数据存储、报告原件存储、一键监测模版配置 |
| AI 层 | Google Gemini API (`gemini-3-flash-preview`) | 报告解析、趋势解读、场景化问答 |
| 语音交互 | Gemini Live API | 低延迟语音对话、三种音色配置、实时转写与要点总结 |
| 可视化 | ECharts（或封装的 React 图表库） | 单指标/多指标折线图、治疗阶段时间轴、关键点与变化率标记 |
| 部署与监控 | 静态托管平台 + 基础监控（如日志/错误上报） | 应用部署、性能与错误监控 |

---

### 11. 产品特色与预期价值

#### 11.1 产品特色

- **病情数据一体化管理**：从报告采集、指标结构化、时间轴可视化，到一键监测方案和 AI 解读，形成闭环。  
- **多指标 + 治疗进程联动可视化**：支持肿瘤标志物、肝肾功能、感染指标等在同一时间轴上与手术/化疗/放疗阶段联动展示。  
- **嵌入式语音 AI 助手**：通过悬浮圆形按钮 + 呼吸灯动效，随时唤起文本/语音对话，帮助用户用“大白话”理解复杂数据。  
- **适老关怀设计**：大字体、圆润组件、精简操作路径，让高龄患者也能独立查看和理解病情趋势。

#### 11.2 用户价值

- 帮助患者和家属**看懂指标与趋势**，降低因“看不懂化验单”带来的恐惧和无力感。  
- 用一键监测视图，快速获得“感染风险、化疗安全、胆汁淤积、血栓风险”等关键信息，方便就诊前自我检查。  
- 通过 AI 助手提前梳理问题，让与医生的面对面沟通更高效、更聚焦。

#### 11.3 医疗与社会价值

- 提升患者对治疗过程的理解，增强治疗依从性，间接提升疗效与随访质量。  
- 减少因信息误解导致的无效就诊与过度恐慌，为医疗系统节约资源。  
- 推动“数据可视化 + AI 助手”在肿瘤慢病管理中的应用探索，为后续多病种扩展提供范例。

---

### 12. 安全与责任原则（风险条款摘要）

#### 12.1 产品定位

- 小紫卡是**病情数据管理与可视化、健康教育与就诊准备工具**，并非医学诊断或治疗决策系统。  
- 应用提供的是**基于公开指南和共识的辅助信息与趋势解读**，不能替代医生的专业判断和面对面诊疗。

#### 12.2 医学安全边界

- 不直接给出“确诊”“治愈”“复发”等结论，仅描述指标变化和风险等级参考。  
- 对于异常指标和高风险提示，统一引导用户：**尽快联系主诊医生或到医疗机构就诊**。  
- 在文案与交互中反复强调：**最终医疗决策必须由专业医生做出**。

#### 12.3 隐私与数据安全原则

- 所有病情数据、报告图片和指标信息仅对当前登录用户可见，不对其他用户公开。  
- 使用 Supabase 行级安全（RLS）等机制，确保不同用户的数据逻辑隔离。  
- 不默认将用户的具体病情数据用于模型训练，任何数据用于模型优化前须获得用户授权。

#### 12.4 免责声明概要

- 本应用的所有内容仅供健康教育和就诊准备参考，**不构成任何形式的医学诊断或治疗建议**。  
- 用户不得将应用输出作为自行调整或中断治疗方案的依据，如有任何治疗相关决定，必须与医生充分沟通后再作出。  
- 在任何疑似急重症或病情明显恶化的情况下，用户应**立即联系当地急诊或主诊医生**，不要依赖本应用做决策。
